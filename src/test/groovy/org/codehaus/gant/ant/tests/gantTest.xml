<?xml version="1.0" encoding="UTF-8" ?>

<!--

Gant - A Groovy build framework based on scripting Ant tasks.

Copyright Â© 2008 Russel Winder

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in
compliance with the License. You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is
distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing permissions and limitations under the
License.

-->

<!--  This build file has to work in two contexts.  If GROOVY_HOME is set in the environment then the jars
  from that installation of Groovy should be used so as to ensure testing in the right context.  If the
  environment does not have a GROOVY_HOME set then grab some specific versions to make things work. -->
 
<project name="Gant Ant Task Test" default="gantTestDefaultTarget" xmlns:artifact="urn:maven-artifact-ant" basedir=".">

  <!--  Assume this test is actually executed from the project top directory.  In order to access the right
  file we have to know where it is. -->

  <property name="theDirectory" value="src/test/groovy/org/codehaus/gant/ant/tests"/>
  <property name ="toplevelDirectory" value="../../../../../../../.."/>

  <property environment="environment"/>

  <condition property="groovyHomeSet">
    <isset property="environment.GROOVY_HOME"/>
  </condition>

  <target name="-initializationWithGroovyHome" if="groovyHomeSet"> 
    <taskdef name="gant" classname="org.codehaus.gant.ant.Gant">
      <classpath>
        <pathelement location="${toplevelDirectory}/target/classes"/>
        <fileset dir="${environment.GROOVY_HOME}/lib" includes="groovy*.jar"/>
        <fileset dir="${environment.GROOVY_HOME}/lib" includes="asm*.jar"/>
        <fileset dir="${environment.GROOVY_HOME}/lib" includes="commons*.jar"/>
        <fileset dir="${environment.GROOVY_HOME}/lib" includes="antlr*.jar"/>
      </classpath>
    </taskdef>
  </target>

  <target name="-initializationOtherwise" unless="groovyHomeSet">

    <!--  There needs to be a refactoring here, the dependencies must be the same as in
    ${toplevelDirectory}/build.xml .-->
    
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant" classpath="${toplevelDirectory}/jarfiles/maven-ant-tasks-2.0.9.jar"/>
    <artifact:dependencies pathId="dependencyClasspath">
      <dependency groupId="org.codehaus.groovy" artifactId="groovy" version="1.5.6"/>
      <dependency groupId="commons-cli" artifactId="commons-cli" version="1.0"/>
    </artifact:dependencies>
    <taskdef name="gant" classname="org.codehaus.gant.ant.Gant">
      <classpath>
        <pathelement location="${toplevelDirectory}/target/classes"/>
        <path refid="dependencyClasspath"/>
      </classpath>
    </taskdef>
  </target>

  <!--  Cannot test not having a file attribute easily since the tests are initiated in the project top
  directory :-(  -->
  
  <target name="gantTestDefaultTarget" depends="-initializationWithGroovyHome,-initializationOtherwise">
    <gant file="${theDirectory}/build.gant"/>
  </target>
 
  <target name="gantTestNamedTarget" depends="-initializationWithGroovyHome,-initializationOtherwise">
    <gant file="${theDirectory}/build.gant" target="blah"/>
  </target>

  <!--  Ensure there is no file of the name used in the Gant Ant task here. -->

  <target name="missingGantfile" depends="-initializationWithGroovyHome,-initializationOtherwise">
    <gant file="blahBlahBlahBlah.blah"/>
  </target>

  <!--  Ensure there is no target called blahBlahBlahBlah. -->

  <target name="gantTaskdef" depends="-initializationWithGroovyHome,-initializationOtherwise">
    <gant file="${theDirectory}/build.gant" target="gantTaskdef"/>
  </target>

</project>
